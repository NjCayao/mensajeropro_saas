üéØ Objetivo
Verificar y corregir todo el sistema existente SIN crear nuevas tablas, solo limpiando y arreglando lo que ya est√°.

FASE 1: Base de Datos - Estructura y Duplicidades
Archivos a presentar:

mensajeropro_saas.sql (dump completo actualizado)

Lo que verificaremos:

Tablas duplicadas o innecesarias
Columnas duplicadas (fecha_expiracion_trial vs suscripciones.fecha_fin)
Relaciones (FOREIGN KEYS) correctas
√çndices faltantes
Campos con nombres inconsistentes

Resultado esperado:

Lista de columnas a eliminar
Lista de tablas a limpiar
SQL para ejecutar correcciones


# FASE 2: Web P√∫blica - Landing y Autenticaci√≥n
Archivos a presentar:
public/index.php
public/login.php
public/registro.php
public/verificar-email.php
sistema/api/v1/auth/registro.php
sistema/api/v1/auth/login.php
sistema/api/v1/auth/google-oauth.php
includes/auth.php
Lo que verificaremos:

Flujo de registro funciona
Flujo de login funciona
Google OAuth funciona
Verificaci√≥n de email funciona
Sesiones se crean correctamente
Redirecciones correctas seg√∫n rol

Resultado esperado:

Bugs identificados
C√≥digo corregido
Flujo documentado


# FASE 3: Panel Cliente - Dashboard y Navegaci√≥n
Archivos a presentar:
sistema/cliente/dashboard.php
sistema/cliente/layouts/header.php
sistema/cliente/layouts/sidebar.php
sistema/cliente/layouts/footer.php
includes/multi_tenant.php
includes/plan-limits.php
Lo que verificaremos:

Dashboard carga correctamente
Sidebar muestra m√≥dulos seg√∫n plan
Multi-tenancy funciona (cada empresa ve solo sus datos)
L√≠mites de plan se respetan
Estad√≠sticas son correctas

Resultado esperado:

Dashboard funcional
Navegaci√≥n limpia
Validaciones correctas


FASE 4: M√≥dulo Contactos y Categor√≠as
Archivos a presentar:
sistema/cliente/modulos/contactos.php
sistema/cliente/modulos/categorias.php
sistema/api/v1/contactos/crear.php
sistema/api/v1/contactos/listar.php
sistema/api/v1/contactos/actualizar.php
sistema/api/v1/contactos/eliminar.php
sistema/api/v1/categorias/*.php (todos)
Lo que verificaremos:

CRUD de contactos completo
CRUD de categor√≠as completo
Importaci√≥n CSV funciona
Filtros funcionan
No hay duplicados

Resultado esperado:

M√≥dulos funcionando 100%
C√≥digo limpio


FASE 5: M√≥dulo Mensajer√≠a
Archivos a presentar:
sistema/cliente/modulos/mensajes.php
sistema/cliente/modulos/programados.php
sistema/cliente/modulos/plantillas.php
sistema/api/v1/mensajes/*.php (todos)
cron/procesar_cola.php
cron/procesar_programados.php
Lo que verificaremos:

Env√≠o individual funciona
Env√≠o masivo funciona
Programados funcionan
Cola funciona
Plantillas se aplican correctamente


FASE 6: WhatsApp y Bot IA
Archivos a presentar:
sistema/cliente/modulos/whatsapp.php
sistema/cliente/modulos/bot-config.php
sistema/api/v1/whatsapp/*.php (todos)
whatsapp-service/src/index.js
whatsapp-service/src/botAgent.js
Lo que verificaremos:

Conexi√≥n WhatsApp funciona
Multi-sesi√≥n funciona (puertos din√°micos)
Bot responde correctamente
Configuraci√≥n del bot se guarda
Notificaciones funcionan


FASE 7: Planes y Suscripciones
Archivos a presentar:
sistema/cliente/modulos/mi-plan.php
sistema/api/v1/suscripciones/*.php (todos)
sistema/api/v1/pagos/*.php (todos)
cron/check-payments.php
Lo que verificaremos:

L√≠mites por plan funcionan
Trial se controla correctamente
Cambios de plan funcionan
Pagos se registran
Vencimientos se detectan


FASE 8: Panel SuperAdmin
Archivos a presentar:
sistema/superadmin/modulos/empresas.php
sistema/superadmin/modulos/planes.php
sistema/superadmin/modulos/pagos.php
sistema/superadmin/modulos/configuracion.php
sistema/superadmin/modulos/emails.php
sistema/superadmin/modulos/logs.php
Lo que verificaremos:

Gesti√≥n de empresas funciona
Gesti√≥n de planes funciona
Suspensi√≥n/activaci√≥n funciona
Configuraci√≥n global funciona
Plantillas email funcionan
Logs se registran


FASE 9: Seguridad y Permisos
Archivos a presentar:
includes/auth.php
includes/superadmin_session_check.php
includes/security.php
config/app.php
Lo que verificaremos:

Validaci√≥n de sesiones correcta
Multi-tenancy no se puede bypassear
CSRF tokens funcionan
SQL injection prevenido
XSS prevenido
SuperAdmin tiene acceso total


FASE 10: Cron Jobs y Automatizaci√≥n
Archivos a presentar:
cron/check-payments.php
cron/send-reminders.php
cron/clean-sessions.php
cron/procesar_cola.php
cron/procesar_programados.php
Lo que verificaremos:

Todos los cron ejecutan sin errores
L√≥gica es correcta
No suspenden al SuperAdmin
Emails se env√≠an correctamente


üìù Metodolog√≠a de Trabajo
Para cada fase:

Presentas los archivos solicitados
Pruebas la funcionalidad manualmente
Me dices qu√© errores encontraste (si hay)
Yo reviso el c√≥digo
Identifico problemas y doy soluciones
Implementas correcciones
Vuelves a probar
Pasamos a la siguiente fase


‚ö†Ô∏è Reglas importantes:

NO crearemos tablas nuevas
NO rehaceremos desde cero
Solo CORREGIMOS lo existente
Avanzamos fase por fase, no saltamos

_______________________

# CHANGELOGS

üìù CHANGELOG - FASE 1: AUDITOR√çA DE BASE DE DATOS
Cambios ejecutados el 04-10-2025

‚úÖ PASO 1: Eliminaci√≥n de columna duplicada
sqlALTER TABLE `empresas` DROP COLUMN `fecha_expiracion_trial`;
Raz√≥n: Duplicaba funcionalidad de suscripciones.fecha_fin. Control de fechas centralizado en tabla suscripciones.

‚úÖ PASO 2: Eliminaci√≥n de tablas duplicadas/obsoletas
A) Tabla de suscripciones duplicada:
sqlDROP TABLE `suscripciones_pago`;
Raz√≥n: Duplicaba suscripciones. Funcionalidad consolidada en una sola tabla.
B) Columna agregada para IDs externos:
sqlALTER TABLE `suscripciones` 
ADD COLUMN `referencia_externa` VARCHAR(100) AFTER `metodo_pago`,
ADD INDEX `idx_referencia_externa` (`referencia_externa`);
Raz√≥n: Para almacenar IDs de MercadoPago/PayPal sin necesidad de tabla separada.
C) Tabla obsoleta de sistema mono-empresa:
sqlDROP TABLE `whatsapp_sesion`;
Raz√≥n: Sistema viejo mono-empresa. Ahora se usa whatsapp_sesiones_empresa.

‚úÖ PASO 3: Eliminaci√≥n de tabla sin uso
sqlDROP TABLE `conocimiento_bot`;
Raz√≥n: Nunca se implement√≥. Funcionalidad cubierta por configuracion_bot.

‚úÖ PASO 4: Foreign Keys agregadas (Integridad Referencial)
sqlALTER TABLE `categorias`
  ADD CONSTRAINT `fk_categorias_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `configuracion_bot`
  ADD CONSTRAINT `fk_config_bot_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `conversaciones_bot`
  ADD CONSTRAINT `fk_conversaciones_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `estados_conversacion`
  ADD CONSTRAINT `fk_estados_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `cola_mensajes`
  ADD CONSTRAINT `fk_cola_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `historial_mensajes`
  ADD CONSTRAINT `fk_historial_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `mensajes_programados`
  ADD CONSTRAINT `fk_programados_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;

ALTER TABLE `plantillas_mensajes`
  ADD CONSTRAINT `fk_plantillas_empresa` 
  FOREIGN KEY (`empresa_id`) REFERENCES `empresas` (`id`) ON DELETE CASCADE;
Raz√≥n: Asegurar integridad referencial. Si se elimina una empresa, todos sus datos se eliminan autom√°ticamente.

‚úÖ PASO 5: Correcci√≥n de UNIQUE Keys
sql-- Antes: nombre √∫nico globalmente
-- Despu√©s: nombre √∫nico por empresa
ALTER TABLE `categorias`
  DROP KEY `nombre_unique`,
  ADD UNIQUE KEY `nombre_empresa_unique` (`empresa_id`, `nombre`);

ALTER TABLE `contactos`
  DROP KEY `numero_unique`,
  ADD UNIQUE KEY `numero_empresa_unique` (`empresa_id`, `numero`);
Raz√≥n: Permitir que diferentes empresas usen los mismos nombres de categor√≠as o n√∫meros de contacto.

‚úÖ PASO 6: Columna faltante
sqlALTER TABLE `cola_mensajes` 
ADD COLUMN `prioridad` TINYINT(1) DEFAULT 1 
COMMENT '1=Normal, 2=Alta, 3=Urgente' 
AFTER `estado`;
Raz√≥n: Corregir error en cron/procesar_cola.php que intentaba ordenar por columna inexistente.

üìä Resumen de impacto

Tablas eliminadas: 3 (suscripciones_pago, whatsapp_sesion, conocimiento_bot)
Columnas eliminadas: 1 (empresas.fecha_expiracion_trial)
Columnas agregadas: 2 (suscripciones.referencia_externa, cola_mensajes.prioridad)
Foreign keys agregadas: 8
UNIQUE keys corregidas: 2
Total de tablas en BD: 42 (antes: 45)


‚ö†Ô∏è Archivos PHP que necesitan actualizaci√≥n
Debido a la eliminaci√≥n de empresas.fecha_expiracion_trial, estos archivos deben modificarse:

cron/check-payments.php (reemplazar referencias a fecha_expiracion_trial)
cron/send-reminders.php (idem)
sistema/superadmin/modulos/empresas.php (cambiar query con JOIN a suscripciones)
Cualquier API que lea fecha_expiracion_trial

# üìù CHANGELOG - FASE 2: AUTENTICACI√ìN Y LANDING PAGE
Fecha: 04-05 Octubre 2025

‚úÖ 1. LANDING PAGE (web/index.php)
Creado desde cero:

Dise√±o moderno inspirado en Kommo con gradientes y animaciones AOS
Sistema de planes din√°mico que lee desde BD (planes table)
4 planes en columnas ordenados por ID
Plan "Empresarial" con bot√≥n "Contactar Ventas" (mailto)
9 tarjetas de caracter√≠sticas destacando todas las funcionalidades
Secci√≥n "C√≥mo funciona" en 3 pasos
Estad√≠sticas (10K+ mensajes, 24/7, etc.)
SEO completo:

Meta tags (description, keywords, author, robots)
Open Graph para Facebook/LinkedIn
Twitter Cards
Schema.org JSON-LD
Canonical URL
Geo tags


D√≠as de trial din√°micos desde BD (configuracion_plataforma.trial_dias)
Responsive completo (mobile, tablet, desktop)

Archivos creados:

web/index.php - Landing principal
web/assets/css/index.css - Estilos del landing
web/terminos.php - T√©rminos y condiciones legales
web/privacidad.php - Pol√≠tica de privacidad
web/robots.txt - Para SEO
web/sitemap.xml - Mapa del sitio


‚úÖ 2. AUTENTICACI√ìN
Login (web/login.php)

Protecci√≥n contra fuerza bruta (m√°x 5 intentos en 15 min)
CSRF token validado
Rate limiting aplicado
Logging de intentos fallidos en tabla intentos_login
Google OAuth (bot√≥n solo si est√° activo desde panel)
Redirecci√≥n autom√°tica seg√∫n rol (cliente/superadmin)

Registro (web/registro.php)

Validaciones completas:

Email v√°lido
Contrase√±a m√≠nimo 8 caracteres
Confirmaci√≥n de contrase√±a
Checkbox t√©rminos y condiciones obligatorio


Rate limiting (m√°x 3 registros por IP/hora)
CSRF token validado
Google OAuth opcional
Creaci√≥n autom√°tica de:

Empresa en empresas
Suscripci√≥n trial en suscripciones
Categor√≠a "General"
Sesi√≥n WhatsApp desconectada
Configuraci√≥n bot (inactiva)
Configuraci√≥n negocio


Token de verificaci√≥n generado
Redirige a verificar email

Google OAuth (sistema/api/v1/auth/google-oauth.php)

Lee configuraci√≥n desde BD (no hardcodeada)
Validaci√≥n de switch activo/inactivo desde panel SuperAdmin
Flujo dual:

Si email existe ‚Üí Login autom√°tico
Si NO existe ‚Üí Registro autom√°tico con email verificado


Mismo proceso de creaci√≥n que registro normal

Verificaci√≥n Email (web/verificar-email.php)

Ya exist√≠a, sin cambios mayores
Integrado con flujo de registro


‚úÖ 3. SEGURIDAD
Nuevo archivo: includes/security.php
Clase SecurityManager con:

verificarIntentosLogin($email, $ip)

Bloquea despu√©s de 5 intentos fallidos en 15 min
Revisa por email O IP


registrarIntentoLogin($email, $ip, $exitoso, $user_agent)

Guarda en tabla intentos_login
Limpia registros > 24 horas autom√°ticamente


verificarRateLimit($accion, $identificador, $max, $ventana_minutos)

Sistema gen√©rico de l√≠mites
Usado para registro (3/hora), etc.


validarCSRF($token)

Compara con $_SESSION['csrf_token'] usando hash_equals()


generarCSRF()

Genera token de 32 bytes si no existe



Nuevas tablas SQL:
sqlCREATE TABLE `intentos_login` (
  id, email, ip, exitoso, user_agent, fecha
)

CREATE TABLE `rate_limit` (
  id, accion, identificador, fecha
)

‚úÖ 4. PANEL SUPERADMIN - GOOGLE OAUTH
sistema/superadmin/modulos/configuracion.php
Nuevo tab "Google OAuth":

Input para Client ID
Input para Client Secret (con toggle show/hide)
Switch activar/desactivar
Instrucciones de configuraci√≥n
URI de redirecci√≥n mostrada

JavaScript actualizado:

Funci√≥n formGoogle que guarda en BD
URL corregida para guardar configuraci√≥n

sistema/api/v1/superadmin/guardar-configuracion.php
Nuevo case en switch:
phpcase 'google':
    guardarConfig('google_client_id', ...);
    guardarConfig('google_client_secret', ...);
    guardarConfig('google_oauth_activo', ...);

‚úÖ 5. CONTROL DE SUSCRIPCIONES
sistema/cliente/modulos/whatsapp.php
Validaci√≥n agregada al inicio:

Consulta suscripciones con estado = 'activa'
Verifica fecha_fin no haya expirado
Si expir√≥ ‚Üí Bloquea acceso con mensaje
Bot√≥n para renovar plan

cron/cerrar-sesiones-vencidas.php (Creado)
Cron job que:

Busca empresas con WhatsApp activo pero suscripci√≥n vencida
Llama al API de WhatsApp para cerrar sesi√≥n
Actualiza BD a estado "desconectado"
Log de operaciones

Para ejecutar:

Local: http://localhost/.../cron/cerrar-sesiones-vencidas.php
Producci√≥n: Cron cada hora


‚úÖ 6. CORRECCIONES POST-AUDITOR√çA
includes/functions.php
Funciones agregadas:
phpfunction obtenerLimitesPlan($empresa_id)
// Ahora consulta suscripciones.fecha_fin
// NO usa empresas.fecha_expiracion_trial (eliminada)

function getWhatsAppServiceUrl()
// Retorna WHATSAPP_API_URL
includes/plan-limits.php
Funci√≥n actualizada:
phpfunction obtenerLimitesPlan()
// JOIN con suscripciones
// Usa fecha_fin y tipo (trial/mensual/anual)
// Calcula dias_restantes con DATEDIFF
sistema/cliente/modulos/whatsapp.php
JavaScript corregido:
javascriptconst WHATSAPP_API_URL = '<?php echo WHATSAPP_API_URL; ?>';
const EMPRESA_ID = <?php echo $_SESSION['empresa_id'] ?? 0; ?>;
// Ya no usa getWhatsAppServiceUrl($empresa_id) dentro de PHP/JS
web/registro.php & google-oauth.php
Cambios:

Usan password_hash (no password)
Usan token_verificacion (no codigo_verificacion)
NO insertan fecha_expiracion_trial en empresas
S√ç crean suscripci√≥n en tabla suscripciones con fecha_fin


‚úÖ 7. INTEGRACI√ìN DE SISTEMAS
Trial Days din√°mico
config/app.php:
phpdefine('TRIAL_DAYS', 30); // Fallback
web/index.php:
php$stmt = $pdo->prepare("SELECT valor FROM configuracion_plataforma WHERE clave = 'trial_dias'");
$trial_dias = $result ? (int)$result['valor'] : TRIAL_DAYS;
SuperAdmin puede cambiar desde panel ‚Üí Se refleja en landing autom√°ticamente
Plan Empresarial
SQL ejecutado:
sqlINSERT INTO planes (nombre, precio_mensual, precio_anual, ...)
VALUES ('Empresarial', 0.00, 0.00, NULL, NULL, ...)
Caracter√≠sticas especiales:

Contactos ilimitados (NULL)
Mensajes ilimitados (NULL)
Bot√≥n "Contactar Ventas" en vez de "Comprar"


üìä ARCHIVOS MODIFICADOS/CREADOS
Creados (15):

web/index.php
web/terminos.php
web/privacidad.php
web/robots.txt
web/sitemap.xml
web/assets/css/index.css
includes/security.php
cron/cerrar-sesiones-vencidas.php
Tablas SQL: intentos_login, rate_limit

Modificados (10):

web/login.php
web/registro.php
sistema/api/v1/auth/google-oauth.php
sistema/superadmin/modulos/configuracion.php
sistema/api/v1/superadmin/guardar-configuracion.php
sistema/cliente/modulos/whatsapp.php
includes/functions.php
includes/plan-limits.php
config/app.php
web/index.php (SEO)


üéØ FUNCIONALIDADES COMPLETADAS

‚úÖ Landing page profesional y atractivo
‚úÖ SEO completo para indexar en Google
‚úÖ Login seguro con protecci√≥n fuerza bruta
‚úÖ Registro con validaciones y t√©rminos
‚úÖ Google OAuth configurable desde panel
‚úÖ Control de suscripciones vencidas
‚úÖ Bloqueo autom√°tico de funciones al vencer
‚úÖ Cron para cerrar WhatsApp de cuentas vencidas
‚úÖ Rate limiting en login y registro
‚úÖ CSRF tokens en todos los formularios
‚úÖ Logging de intentos sospechosos
‚úÖ Sistema multi-tenant con suscripciones

üé® Mejoras de Interfaz
Login (web/login.php):

Dise√±o de dos columnas (panel izquierdo con features, derecho con formulario)
Tipograf√≠a Inter moderna
CSS inline optimizado (sin dependencia de AdminLTE)
Animaciones y transiciones suaves
Estados hover y focus mejorados
Responsive completo

Registro (web/registro.php):

Dise√±o coherente con login
Badge din√°mico de d√≠as de trial (lee desde BD)
Lista de beneficios en panel izquierdo
Validaci√≥n visual en campos requeridos
CSS inline optimizado


üîí Sistema de Recuperaci√≥n de Contrase√±a
Archivos creados:

web/recuperar-password.php - Solicitar recuperaci√≥n
web/resetear-password.php - Cambiar contrase√±a con token

Caracter√≠sticas:

Token con expiraci√≥n (1 hora)
Rate limiting (3 intentos/hora)
Mensajes gen√©ricos (seguridad contra user enumeration)
Dise√±o moderno coherente con login/registro
Columnas SQL agregadas: password_reset_token, password_reset_expires


üõ°Ô∏è Sistema de Seguridad Anti-Spam
Panel SuperAdmin - Nueva pesta√±a "Seguridad":
1. Google reCAPTCHA v3:

Configuraci√≥n de Site Key y Secret Key
Switch activar/desactivar
Integrado en web/registro.php
Score m√≠nimo: 0.5

2. Honeypot:

Campo invisible trampa para bots
Activable/desactivable desde panel
Sin configuraci√≥n adicional

3. Bloqueo de Emails Temporales:

Lista editable de dominios bloqueados (textarea)
Por defecto: 10minutemail, tempmail, guerrillamail, etc.
Validaci√≥n en servidor antes de registrar

4. Verificaci√≥n de Email Obligatoria:

Switch para requerir verificaci√≥n antes de activar cuenta
Si activo: empresas.activo = 0 hasta verificar
Si inactivo: empresas.activo = 1 inmediatamente

Nuevas configs en BD:
sqlrecaptcha_site_key
recaptcha_secret_key
recaptcha_activo
honeypot_activo
bloquear_emails_temporales
dominios_temporales
verificacion_email_obligatoria
Archivo actualizado:

sistema/api/v1/superadmin/guardar-configuracion.php - Case 'seguridad'


üìß Sistema de Plantillas de Email en BD
Migraci√≥n completa de hardcoded a BD:
Tabla existente aprovechada: plantillas_email
Plantillas agregadas:

verificacion_email - C√≥digo de verificaci√≥n al registrarse
recuperacion_password - Link de recuperaci√≥n de contrase√±a

M√≥dulo SuperAdmin creado:

sistema/superadmin/modulos/emails.php
Gesti√≥n CRUD de plantillas
Editor HTML inline
Vista previa en modal
Filtros por categor√≠a y estado
Variables din√°micas (JSON)

APIs usadas (ya exist√≠an):

email-detalles.php
toggle-email.php
eliminar-email.php
guardar-email.php
crear-email.php

Funciones actualizadas en includes/functions.php:
phpenviarEmailPlantilla() // Nueva funci√≥n base
enviarEmailVerificacion() // Ahora usa BD
enviarEmailRecuperacion() // Ahora usa BD
Archivo eliminado:

includes/email-templates.php (sistema hardcodeado antiguo)


üîß Correcciones T√©cnicas

URL de guardado en configuraci√≥n corregida (error 403/404)
Validaciones de seguridad movidas dentro del bloque POST en registro.php
Variable $empresa_id definida correctamente con lastInsertId()
Flujo de validaciones en cascada (CSRF ‚Üí Rate limit ‚Üí Honeypot ‚Üí reCAPTCHA ‚Üí Campos ‚Üí Emails temporales)


Archivos Totales Modificados/Creados en FASE 2 COMPLETA
Creados (21):
1-5. Landing, t√©rminos, privacidad, robots, sitemap
6. includes/security.php
7-8. web/recuperar-password.php, web/resetear-password.php
9. cron/cerrar-sesiones-vencidas.php
10-11. Tablas SQL: intentos_login, rate_limit
12. sistema/superadmin/modulos/emails.php
13-14. Plantillas SQL: verificacion_email, recuperacion_password
Modificados (15):
1-2. web/login.php, web/registro.php (dise√±o completo)
3. sistema/api/v1/auth/google-oauth.php
4-5. sistema/superadmin/modulos/configuracion.php (tab seguridad)
6. sistema/api/v1/superadmin/guardar-configuracion.php (case seguridad)
7. sistema/cliente/modulos/whatsapp.php (validaci√≥n suscripci√≥n)
8-9. includes/functions.php, includes/plan-limits.php
10. config/app.php
11. web/index.php
12-14. Login/registro/recuperaci√≥n (nuevos dise√±os)
15. Tabla empresas (columnas password_reset)

